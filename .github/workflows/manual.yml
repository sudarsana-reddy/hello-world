# This is a basic workflow that is manually triggered

name: Manual workflow

env:
  PEGA_APP_NAME: DMSample
  PEGA_APP_VERSION: 01.01.01
  PEGA_API_ASYNC: false
  PEGA_ARCHIVE_NAME: MyDMSample.zip

# Controls when the action will run. Workflow runs when manually triggered using the UI
# or API.
on:
  workflow_dispatch:
    # Inputs the workflow accepts.
    inputs:
      name:
        # Friendly description to be shown in the UI instead of 'name'
        description: 'Person to greet'
        # Default value if no value is explicitly provided
        default: 'World'
        # Input has to be provided for the workflow to run
        required: true
        
      PEGA_APP_NAME:
        # Friendly description to be shown in the UI instead of 'name'
        description: 'PEGA App Name to export'
        # Default value if no value is explicitly provided
        default: 'DMSample'
        # Input has to be provided for the workflow to run
        required: true
        
      PEGA_APP_VERSION:
        # Friendly description to be shown in the UI instead of 'name'
        description: 'PEGA App Version to export'
        # Default value if no value is explicitly provided
        default: '01.01.01'
        # Input has to be provided for the workflow to run
        required: true
        
      PEGA_ARCHIVE_NAME:
        # Friendly description to be shown in the UI instead of 'name'
        description: 'PEGA App exported file name'
        # Default value if no value is explicitly provided
        default: 'MyDMSample.zip'
        # Input has to be provided for the workflow to run
        required: true
        
      PEGA_API_ASYNC:
        # Friendly description to be shown in the UI instead of 'name'
        description: 'Async Pega API?'
        # Default value if no value is explicitly provided
        default: false
        # Input has to be provided for the workflow to run
        required: true
        
     

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "greet"
  greet:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    # Runs a single command using the runners shell
    - name: Send greeting
      run: |
        echo "Hello ${{ github.event.inputs.name }}"        
        pwd 
        curl -o prpc87.zip https://d2xbzkyevnvl4b.cloudfront.net/prpcServiceUtils_8.7.zip
        unzip prpc87.zip -d prpc87           
        cd prpc87
        ls        
        cd scripts/utils
        echo "***********************Updating the file *****************************"
        echo ${{secrets.PEGA_URL}}
        sed -i -r "s#(pega.rest.server.url=)(.*)#\1${{secrets.PEGA_URL}}#" prpcServiceUtils.properties
        sed -i -r "s#(pega.rest.username=)(.*)#\1${{secrets.PEGA_USERNAME}}#" prpcServiceUtils.properties
        sed -i -r "s#(pega.rest.password=)(.*)#\1${{secrets.PEGA_PASSWORD}}#" prpcServiceUtils.properties
        sed -i -r "s#(pega.rest.response.type=)(.*)#\1${{secrets.PEGA_REST_RESPONSE_TYPE}}#" prpcServiceUtils.properties
        sed -i -r "s#(export.applicationVersion=)(.*)#\1${{env.PEGA_APP_VERSION}}#" prpcServiceUtils.properties
        sed -i -r "s#(export.applicationName=)(.*)#\1${{github.event.inputs.PEGA_APP_NAME}}#" prpcServiceUtils.properties
        sed -i -r "s#(export.async=)(.*)#\1${{env.PEGA_API_ASYNC}}#" prpcServiceUtils.properties
        sed -i -r "s#(export.productVersion=)(.*)##" prpcServiceUtils.properties
        sed -i -r "s#(export.productName=)(.*)##" prpcServiceUtils.properties
         sed -i -r "s#(export.archiveName=)(.*)#\1${{env.PEGA_ARCHIVE_NAME}}#" prpcServiceUtils.properties
        echo "**********Updating the file completed***************"      
        mkdir artifacts
        ls
        chmod 711 ./../bin/ant        
        echo "^^^^^^^^^^^^^^^^^^^^^^^Staring the export^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^"
        bash ./prpcServiceUtils.sh export --propFile prpcServiceUtils.properties --artifactsDir ./artifacts
        ls
        cd artifacts
        ls
        cd ..
        
    - name: Upload a Build Artifact
      uses: actions/upload-artifact@v3.1.0
      with:
        # Artifact name
        name: MyDMSample-Artifacts
        # A file, directory or wildcard pattern that describes what to upload
        path: ${{ github.workspace }}/prpc87/scripts/utils/artifacts/
       
  
        
        
